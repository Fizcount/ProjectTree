<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>ProjectTree ClearView</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  :root {
    --primary: #3b82f6;
    --bg: #f8fafc; --surface: #ffffff;
    --border: #cbd5e1; --text: #1e293b; 
    --line-color: #94a3b8; /* Garis lebih gelap agar terlihat */
    --control-h: 44px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
  body {
    font-family: 'Inter', system-ui, sans-serif;
    background-color: var(--bg); color: var(--text);
    padding: 1.5rem 1rem; line-height: 1.5; min-height: 100vh;
  }
  
  .container { max-width: 1100px; margin: 0 auto; }
  header { margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
  .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 1.4rem; color: #0f172a; }

  /* CARD */
  .card {
    background: var(--surface); border-radius: 16px;
    box-shadow: 0 4px 20px -5px rgba(0,0,0,0.1); border: 1px solid var(--border);
    overflow: hidden; position: relative; min-height: 300px;
  }

  /* TOOLBAR GRID */
  .toolbar {
    padding: 1rem; background: #f1f5f9; border-bottom: 1px solid var(--border);
    display: grid; gap: 10px; grid-template-columns: 1fr;
  }
  @media (min-width: 640px) { .toolbar { grid-template-columns: auto 1fr auto; } }

  .row-group { display: flex; gap: 10px; }
  .btn, input, select {
    height: var(--control-h); padding: 0 1rem; border: 1px solid var(--border);
    border-radius: 8px; font-size: 0.9rem; background: white; width: 100%;
    display: flex; align-items: center; justify-content: center; gap:6px;
  }
  .btn:hover { background: #e2e8f0; }
  .btn.active { background: #dbeafe; border-color: var(--primary); color: var(--primary); }

  /* FILTER MODAL */
  .filter-panel {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
    width: 90%; max-width: 360px; background: white; padding: 1.5rem;
    border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
    z-index: 1000; opacity: 0; pointer-events: none; transition: 0.2s;
  }
  .filter-panel.show { opacity: 1; pointer-events: all; transform: translate(-50%, -50%) scale(1); }
  .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; }
  .backdrop.show { display: block; }
  
  .chk-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 200px; overflow-y: auto; margin: 10px 0; }
  .chk-item { display: flex; gap: 8px; font-size: 0.85rem; align-items: center; }
  
  /* DROP ZONE */
  .drop-zone {
    border: 2px dashed #cbd5e1; border-radius: 12px; padding: 3rem 1rem;
    text-align: center; margin: 1.5rem; cursor: pointer; color: #64748b;
  }
  .drop-zone:hover { border-color: var(--primary); background: #f0f9ff; color: var(--primary); }

  /* TREE VIEW */
  .tree-container {
    background: #0f172a; /* Dark theme default for code */
    color: #e2e8f0;
    padding: 1.5rem; font-family: "Consolas", "Monaco", monospace; font-size: 13.5px;
    overflow-x: auto; min-height: 400px; display: none;
    line-height: 1.6;
  }
  .tree-container.show { display: block; }

  /* --- HIERARCHY LINES (PENTING) --- */
  .t-children {
    padding-left: 20px; 
    border-left: 2px solid #334155; /* Garis default tebal */
    margin-left: 7px;
  }
  
  .t-node { display: block; white-space: nowrap; }
  .t-head { display: flex; align-items: center; border-radius: 4px; padding: 2px 0; cursor: pointer; }
  .t-head:hover { background: rgba(255,255,255,0.1); }

  /* Icons */
  .t-arrow { width: 14px; height: 14px; margin-right: 4px; color: #94a3b8; transition: 0.2s; }
  .t-node.collapsed .t-arrow { transform: rotate(-90deg); }
  .t-node.collapsed .t-children { display: none; }
  .t-icon { width: 16px; height: 16px; margin-right: 8px; }

  /* File Colors */
  .c-folder { color: #fbbf24; } 
  .c-js { color: #facc15; } .c-html { color: #f87171; } .c-css { color: #22d3ee; } 
  .c-json { color: #a3e635; } .c-img { color: #4ade80; } .c-def { color: #94a3b8; }
  
  .t-meta { font-size: 11px; color: #64748b; margin-right: 10px; min-width: 50px; text-align: right; }
  .t-comment { color: #34d399; font-style: italic; opacity: 0.7; font-size: 12px; margin-left: 8px; }

  /* --- EXPORT MODE (Agar Screenshot Jelas) --- */
  .tree-container.export-mode {
    background: #000000 !important; /* Hitam pekat */
    padding: 2rem !important;
  }
  .tree-container.export-mode .t-children {
    border-left: 2px solid #555 !important; /* Garis abu terang saat export */
  }
  .tree-container.export-mode .t-meta { display: none; } /* Sembunyikan size saat foto biar bersih */
  
  /* Loading & Toast */
  .loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.9); z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
  .loading-overlay.active { opacity: 1; pointer-events: all; }
  .toast { position: fixed; bottom: 2rem; left: 50%; transform: translate(-50%, 100px); background: #10b981; color: white; padding: 10px 20px; border-radius: 50px; font-weight: 600; opacity: 0; transition: 0.3s; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
  .toast.show { transform: translate(-50%, 0); opacity: 1; }
  
  #pick { display: none; }
</style>
</head>
<body>

<div class="container">
  <header>
    <div class="brand">üìÇ ProjectTree</div>
    <button class="btn" style="width:auto" onclick="window.location.reload()">Reset</button>
  </header>

  <div class="card">
    <div id="loading" class="loading-overlay">Processing...</div>

    <div class="toolbar">
      <button id="btnFilter" class="btn">‚öôÔ∏è Filter Settings</button>
      <div class="row-group">
        <select id="selStyle"><option value="unicode">Style: Unicode</option><option value="ascii">Style: ASCII</option></select>
        <input id="inpExt" type="text" placeholder="Ext (.js, .py)" />
      </div>
      <div class="row-group">
        <button id="btnCopy" class="btn">üìã Copy</button>
        <button id="btnJson" class="btn">JSON</button>
        <button id="btnImg" class="btn" style="background:#0f172a; color:white; border:none">üì∏ IMG</button>
      </div>
    </div>

    <div id="backdrop" class="backdrop"></div>
    <div id="filterPanel" class="filter-panel">
      <h3>Ignore Settings</h3>
      <div style="margin:10px 0; display:flex; gap:10px; align-items:center;">
        <span>Enabled</span> <input type="checkbox" id="masterToggle" checked>
      </div>
      <div id="filterGrid" class="chk-list"></div>
      <input id="inpIgnore" type="text" placeholder="Manual: assets, *.log" />
      <button class="btn" style="margin-top:10px; background:var(--primary); color:white" onclick="toggleFilter(false)">Done</button>
    </div>

    <div id="dropZone" class="drop-zone">
      <h3>Tap / Drag Folder Here</h3>
      <p>Browser tidak mendeteksi folder kosong (0 file).</p>
    </div>
    <div id="treeContainer" class="tree-container"></div>
  </div>
</div>
<div id="toast" class="toast">Action Success!</div>
<input type="file" id="pick" webkitdirectory multiple />

<script>
/* --- CONFIG & STATE --- */
const COMMON = ["node_modules", ".git", ".vscode", "dist", "build", "coverage", "__pycache__", ".DS_Store", "logs", ".env", "venv"];
let allFiles = [], activeFilters = new Set(COMMON), isFilterOn = true;

const els = {
  pick: document.getElementById('pick'), drop: document.getElementById('dropZone'),
  tree: document.getElementById('treeContainer'), backdrop: document.getElementById('backdrop'),
  panel: document.getElementById('filterPanel'), grid: document.getElementById('filterGrid'),
  loading: document.getElementById('loading'), toast: document.getElementById('toast')
};

/* --- INIT --- */
COMMON.forEach(f => {
  const div = document.createElement('div'); div.className='chk-item';
  const chk = document.createElement('input'); chk.type='checkbox'; chk.checked=true; chk.value=f;
  chk.onchange = () => { chk.checked ? activeFilters.add(f) : activeFilters.delete(f); reProcess(); };
  div.append(chk, f); els.grid.appendChild(div);
});

/* --- ACTIONS --- */
function toggleFilter(show) {
  els.panel.classList.toggle('show', show); els.backdrop.classList.toggle('show', show);
}
document.getElementById('btnFilter').onclick = () => toggleFilter(true);
els.backdrop.onclick = () => toggleFilter(false);

document.getElementById('masterToggle').onchange = (e) => {
  isFilterOn = e.target.checked; reProcess();
};
document.getElementById('inpIgnore').oninput = reProcess;
document.getElementById('inpExt').oninput = reProcess;

function reProcess() { if(allFiles.length) processFiles(allFiles, true); }

/* --- CORE LOGIC --- */
els.drop.onclick = () => els.pick.click();
els.pick.onchange = () => processFiles(Array.from(els.pick.files));

document.body.addEventListener('dragover', e => { e.preventDefault(); document.body.style.background = '#e0f2fe'; });
document.body.addEventListener('drop', e => { 
  e.preventDefault(); document.body.style.background = ''; 
  if(e.dataTransfer.files.length) processFiles(Array.from(e.dataTransfer.files));
});

async function processFiles(files, rerun=false) {
  if(!rerun) allFiles = files;
  els.loading.classList.add('active');
  await new Promise(r => setTimeout(r, 20));

  if(!rerun) { els.drop.style.display='none'; els.tree.classList.add('show'); }
  els.tree.innerHTML = '';

  const root = { name: "root", type: "folder", children: {}, count: 0 };
  const custom = document.getElementById('inpIgnore').value.split(',').map(s=>s.trim()).filter(Boolean);
  const exts = document.getElementById('inpExt').value.split(',').map(s=>s.trim()).filter(Boolean);

  for (const f of files) {
    if(isFilterOn) {
      const parts = f.webkitRelativePath.split('/');
      if (parts.some(p => activeFilters.has(p) || custom.some(c => c.startsWith('*')?p.endsWith(c.slice(1)):p===c))) continue;
    }
    if (exts.length && !exts.some(e => f.name.endsWith(e))) continue;

    let curr = root;
    const parts = f.webkitRelativePath.split('/');
    for (let i = 0; i < parts.length; i++) {
      const p = parts[i], isFile = i === parts.length-1;
      if (!curr.children[p]) curr.children[p] = { name: p, type: isFile?'file':'folder', children: {}, count: 0, size: isFile?f.size:0 };
      curr = curr.children[p];
    }
  }

  calcStats(root); sortTree(root);
  const data = root.children[Object.keys(root.children)[0]];
  
  if(data) els.tree.appendChild(renderDOM(data));
  else els.tree.innerHTML = '<div style="text-align:center; padding:2rem; color:#aaa">Folder kosong atau semua file ter-filter.</div>';
  
  els.loading.classList.remove('active');
}

/* --- RENDER --- */
function renderDOM(n) {
  const isF = n.type === 'folder';
  const el = document.createElement('div'); el.className = 't-node';
  const head = document.createElement('div'); head.className = 't-head';
  
  head.innerHTML = `
    <span class="t-arrow">${isF ? '‚ñº' : ''}</span>
    <span class="t-icon">${isF ? 'üìÅ' : 'üìÑ'}</span>
    <span style="color:${getColor(n.name, isF)}">${n.name}</span>
    <span class="t-meta">${isF ? '' : sizeStr(n.size)}</span>
    <span class="t-comment" contenteditable="true" spellcheck="false" onclick="event.stopPropagation()"></span>
  `;
  
  if(isF) {
    head.onclick = (e) => { 
      if(e.target.isContentEditable) return;
      el.classList.toggle('collapsed'); 
      const arr = head.querySelector('.t-arrow');
      arr.innerText = el.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
    };
  } else {
    head.querySelector('.t-arrow').style.visibility = 'hidden';
  }

  el.appendChild(head);
  if(isF) {
    const childs = document.createElement('div'); childs.className = 't-children';
    for(let k in n.children) childs.appendChild(renderDOM(n.children[k]));
    el.appendChild(childs);
  }
  return el;
}

/* --- EXPORT IMAGE FIX --- */
document.getElementById('btnImg').onclick = () => {
  if(!els.tree.firstChild) return;
  const t = els.tree;
  
  // 1. Force High Contrast Mode
  t.classList.add('export-mode');
  
  html2canvas(t, {
    backgroundColor: "#000000", // Paksa background hitam pekat
    scale: 2, // Resolusi tinggi
    windowWidth: t.scrollWidth + 50
  }).then(c => {
    // 2. Remove Mode
    t.classList.remove('export-mode');
    
    const a = document.createElement('a'); a.download = 'project-tree.png'; a.href = c.toDataURL(); a.click();
    showToast("Image Downloaded");
  });
};

document.getElementById('btnCopy').onclick = () => {
  if(!els.tree.firstChild) return;
  // Simple text builder
  const build = (d, pre="", last=true) => {
    let str = pre + (last?"‚îî‚îÄ‚îÄ ":"‚îú‚îÄ‚îÄ ") + d.querySelector('span:nth-child(3)').innerText + "\n";
    const ch = d.querySelector('.t-children');
    if(ch && !d.classList.contains('collapsed')) {
      const kids = Array.from(ch.children);
      kids.forEach((k, i) => str += build(k, pre+(last?"    ":"‚îÇ   "), i===kids.length-1));
    }
    return str;
  };
  navigator.clipboard.writeText(build(els.tree.firstChild, "", true));
  showToast("Copied to Clipboard");
};

/* --- UTILS --- */
function getColor(n, isF) {
  if(isF) return '#fbbf24';
  const ext = n.split('.').pop();
  return {js:'#facc15', html:'#f87171', css:'#22d3ee', json:'#a3e635'}[ext] || '#e2e8f0';
}
function sizeStr(b) { return b<1024?b+'B':(b/1024).toFixed(1)+'KB'; }
function calcStats(n) { if(n.type==='file')return; for(let k in n.children) calcStats(n.children[k]); }
function sortTree(n) { 
  if(n.type==='file')return; 
  const k=Object.keys(n.children).sort((a,b)=>{
    const A=n.children[a], B=n.children[b];
    return A.type!==B.type ? (A.type==='folder'?-1:1) : a.localeCompare(b);
  });
  const o={}; k.forEach(x=>{o[x]=n.children[x]; sortTree(o[x])}); n.children=o;
}
function showToast(m) { 
  els.toast.textContent=m; els.toast.classList.add('show'); 
  setTimeout(()=>els.toast.classList.remove('show'), 2000); 
}
</script>
</body>
</html>
