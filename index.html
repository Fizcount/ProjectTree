<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ProjectTree Ultimate v2</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  :root {
    --primary: #3b82f6;
    --primary-hover: #2563eb;
    --bg: #f1f5f9;
    --surface: #ffffff;
    --border: #e2e8f0;
    --text: #334155;
    --text-muted: #94a3b8;
    --code-bg: #1e293b;
    --code-text: #e2e8f0;
    --line-color: #475569;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
  
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: var(--bg);
    color: var(--text);
    padding: 2rem 1rem;
    line-height: 1.5;
    min-height: 100vh; /* Agar bisa drop di mana saja */
  }

  .container { max-width: 1100px; margin: 0 auto; position: relative; }

  /* --- HEADER --- */
  header { margin-bottom: 2rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
  .brand { display: flex; align-items: center; gap: 12px; }
  .brand h1 { font-size: 1.5rem; font-weight: 700; color: #0f172a; }
  .brand-icon { width: 32px; height: 32px; color: var(--primary); }

  /* --- CARD --- */
  .card {
    background: var(--surface);
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    border: 1px solid var(--border);
    overflow: hidden;
    margin-bottom: 1.5rem;
    position: relative; /* Untuk loading overlay */
    min-height: 300px;
  }

  /* --- LOADING OVERLAY --- */
  .loading-overlay {
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(2px);
    z-index: 50;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .loading-overlay.active { opacity: 1; pointer-events: all; }

  .spinner {
    width: 48px; height: 48px;
    border: 4px solid #e2e8f0;
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 1rem;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-weight: 600; color: var(--text); }

  /* --- TOOLBAR --- */
  .toolbar {
    padding: 1.25rem;
    border-bottom: 1px solid var(--border);
    background: #f8fafc;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
  }

  .group { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  .divider { width: 1px; height: 24px; background: var(--border); margin: 0 8px; }

  input[type="text"], select {
    padding: 0.5rem 0.75rem;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    font-size: 0.875rem;
    color: var(--text);
    background: white;
  }
  input[type="text"]:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }

  /* BUTTONS */
  .btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 0.5rem 0.85rem; border-radius: 6px;
    font-weight: 500; font-size: 0.875rem; cursor: pointer;
    border: 1px solid var(--border); background: white; color: var(--text);
    transition: all 0.2s;
  }
  .btn:hover { background: #f1f5f9; border-color: #94a3b8; }
  .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
  .btn-primary:hover { background: var(--primary-hover); }
  .btn svg { width: 16px; height: 16px; }

  /* --- DROP ZONE --- */
  .drop-zone {
    border: 2px dashed #cbd5e1;
    border-radius: 8px;
    padding: 3rem;
    text-align: center;
    background: white;
    margin: 1.5rem;
    transition: all 0.2s;
    cursor: pointer;
    color: var(--text-muted);
  }
  /* Global Drag State (on Body) */
  body.drag-active .drop-zone { border-color: var(--primary); background: #eff6ff; color: var(--primary); }
  body.drag-active .card { border-color: var(--primary); }
  
  .drop-zone-icon { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5; }

  /* --- TREE VIEW (DOM) --- */
  .tree-container {
    background: var(--code-bg);
    color: var(--code-text);
    padding: 1.5rem;
    font-family: "Fira Code", Consolas, monospace;
    font-size: 14px;
    overflow-x: auto;
    min-height: 400px;
    display: none; /* Hidden by default */
  }
  .tree-container.show { display: block; }

  /* Tree Nodes Styling (Sama seperti sebelumnya) */
  .t-node { display: block; }
  .t-head { display: flex; align-items: center; padding: 2px 0; cursor: pointer; user-select: none; }
  .t-head:hover { background: rgba(255,255,255,0.05); }
  .indent { display: inline-block; width: 24px; height: 100%; border-right: 1px solid transparent; flex-shrink: 0; }
  .indent.line { border-right-color: var(--line-color); }
  .t-icon { width: 18px; height: 18px; margin-right: 8px; flex-shrink: 0; }
  .t-arrow { width: 14px; height: 14px; margin-right: 4px; transition: transform 0.2s; color: var(--text-muted); }
  .t-node.collapsed .t-arrow { transform: rotate(-90deg); }
  .t-arrow.hidden { visibility: hidden; }
  .t-name { margin-right: 12px; }
  .t-meta { font-size: 12px; color: #64748b; margin-right: 12px; }
  .t-comment { color: #059669; font-style: italic; opacity: 0.7; border-bottom: 1px dashed transparent; min-width: 20px; }
  .t-comment:hover, .t-comment:focus { opacity: 1; border-bottom-color: #059669; }
  .t-comment:empty::before { content: "# click to add comment"; color: #475569; }
  .t-comment:focus::before { content: ""; }
  .c-folder { color: #fcd34d; }
  .c-js { color: #f59e0b; } .c-ts { color: #3b82f6; }
  .c-html { color: #ef4444; } .c-css { color: #06b6d4; }
  .c-json { color: #84cc16; } .c-md { color: #a855f7; }
  .c-img { color: #10b981; } .c-def { color: #94a3b8; }
  .t-children { margin-left: 0; padding-left: 22px; border-left: 1px solid var(--line-color); margin-left: 9px; }
  .t-node.collapsed .t-children { display: none; }

  /* Toast */
  .toast {
    position: fixed; bottom: 2rem; right: 2rem;
    background: #10b981; color: white;
    padding: 0.75rem 1.5rem; border-radius: 8px;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    transform: translateY(100px); opacity: 0; transition: all 0.3s;
    font-weight: 600; display: flex; align-items: center; gap: 8px; z-index: 99;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* Hidden Input */
  #pick { display: none; }
</style>
</head>
<body>

<div class="container">
  <header>
    <div class="brand">
      <svg class="brand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>
      <h1>ProjectTree</h1>
    </div>
    <div class="group">
      <button class="btn" onclick="window.location.reload()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
        Reset
      </button>
    </div>
  </header>

  <div class="card">
    <div id="loading" class="loading-overlay">
      <div class="spinner"></div>
      <div class="loading-text">Processing files...</div>
      <div id="loadingCount" style="font-size:0.8rem; color:#64748b; margin-top:5px">Please wait</div>
    </div>

    <div class="toolbar">
      <div class="group">
        <label for="pick" class="btn btn-primary">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Select Folder
        </label>
        <div class="divider"></div>
        <select id="selStyle" class="btn">
          <option value="unicode">Style: Unicode (├──)</option>
          <option value="ascii">Style: ASCII (|--)</option>
        </select>
        <button id="btnCopy" class="btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
          Copy Text
        </button>
      </div>

      <div class="group" style="margin-left:auto">
        <button id="btnJson" class="btn">JSON</button>
        <button id="btnImg" class="btn">PNG Image</button>
      </div>
      
      <div style="width:100%; margin-top:10px" class="group">
        <input id="inpIgnore" type="text" placeholder="Ignore (e.g. node_modules, .git)" style="flex:2" />
        <input id="inpExt" type="text" placeholder="Filter Ext (e.g. .js, .py)" style="flex:1" />
      </div>
    </div>

    <div id="dropZone" class="drop-zone">
      <svg class="drop-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
      <div style="font-weight:600; color:var(--text)">Drag & Drop folder here</div>
      <div style="font-size:0.8rem; margin-top:0.5rem">or drop anywhere on the page to update</div>
    </div>

    <div id="treeContainer" class="tree-container"></div>
  </div>
</div>

<input type="file" id="pick" webkitdirectory multiple />

<div id="toast" class="toast">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
  <span id="toastMsg">Action Successful</span>
</div>

<script>
/* ================== ICONS ================== */
const ICONS = {
  arrow: `<svg class="t-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>`,
  folder: `<svg class="t-icon c-folder" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>`,
  file: `<svg class="t-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>`
};

/* ================== CONFIG ================== */
const DEFAULT_IGNORE = new Set(["node_modules",".git",".vscode",".idea","dist","build","__pycache__",".DS_Store"]);

/* ================== STATE ================== */
let fileStructure = {}; 
const els = {
  pick: document.getElementById('pick'),
  drop: document.getElementById('dropZone'),
  tree: document.getElementById('treeContainer'),
  ignore: document.getElementById('inpIgnore'),
  ext: document.getElementById('inpExt'),
  toast: document.getElementById('toast'),
  selStyle: document.getElementById('selStyle'),
  loading: document.getElementById('loading'),
  loadingCount: document.getElementById('loadingCount')
};

// Load Prefs
els.ignore.value = localStorage.getItem('pt_ignore') || "";
els.ext.value = localStorage.getItem('pt_ext') || "";

/* ================== CORE LOGIC ================== */

async function processFiles(files) {
  if (!files.length) return;

  // 1. SHOW LOADING & RESET UI
  els.loading.classList.add('active');
  els.loadingCount.textContent = `Analyzing ${files.length} files...`;
  
  // Use setTimeout to allow UI to update (spinner to appear) before heavy processing
  await new Promise(r => setTimeout(r, 50));

  try {
    // 2. RESET STATE (Otomatis Timpa)
    fileStructure = {}; 
    els.tree.innerHTML = ''; 
    els.drop.style.display = 'none'; // Hide dropzone
    els.tree.classList.add('show');  // Show tree container

    // Prepare filters
    const manualIgnore = els.ignore.value.split(',').map(s=>s.trim()).filter(Boolean);
    const ignoreSet = new Set([...DEFAULT_IGNORE, ...manualIgnore]);
    const allowedExts = els.ext.value.split(',').map(s=>s.trim()).filter(Boolean);

    // Check .gitignore
    const gitignore = files.find(f => f.name === ".gitignore");
    if(gitignore) {
      try {
        const txt = await gitignore.text();
        txt.split(/\r?\n/).forEach(l => {
          l = l.trim(); 
          if(l && !l.startsWith('#')) ignoreSet.add(l.replace(/\/$/,''));
        });
      } catch(e){}
    }

    // Build Data Structure
    const root = { name: "root", type: "folder", children: {}, size: 0, count: 0 };
    
    // BUILD LOOP
    for (const f of files) {
      const parts = f.webkitRelativePath.split('/');
      if (parts.some(p => ignoreSet.has(p))) continue;
      if (allowedExts.length && !allowedExts.some(e => f.name.endsWith(e))) continue;

      let curr = root;
      for (let i = 0; i < parts.length; i++) {
        const part = parts[i];
        const isFile = (i === parts.length - 1);
        if (!curr.children[part]) {
          curr.children[part] = {
            name: part,
            type: isFile ? "file" : "folder",
            children: {},
            size: isFile ? f.size : 0,
            count: 0
          };
        }
        curr = curr.children[part];
      }
    }

    // CALC & SORT
    calcStats(root);
    sortChildren(root);

    // RENDER
    fileStructure = root.children[Object.keys(root.children)[0]]; // Un-nest
    
    if(!fileStructure) {
      // Case: Folder empty or all ignored
      els.tree.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-muted)">No files found (check filters)</div>';
    } else {
      renderTree(fileStructure);
    }

  } catch (err) {
    console.error(err);
    alert("Error processing files");
  } finally {
    // 3. HIDE LOADING
    els.loading.classList.remove('active');
  }
}

// ... (Helper functions remain similar but optimized) ...

function calcStats(node) {
  if (node.type === "file") return;
  let sumSize = 0;
  let sumCount = 0;
  for (const key in node.children) {
    const child = node.children[key];
    calcStats(child);
    sumSize += child.size;
    sumCount += (child.type === 'file' ? 1 : child.count);
  }
  node.size = sumSize;
  node.count = Object.keys(node.children).length;
}

function sortChildren(node) {
  if (node.type === 'file') return;
  const sortedKeys = Object.keys(node.children).sort((a,b) => {
    const nA = node.children[a], nB = node.children[b];
    if (nA.type !== nB.type) return nA.type === 'folder' ? -1 : 1;
    return a.localeCompare(b);
  });
  const newChildren = {};
  sortedKeys.forEach(k => { newChildren[k] = node.children[k]; sortChildren(newChildren[k]); });
  node.children = newChildren;
}

function renderTree(data) {
  els.tree.innerHTML = '';
  els.tree.appendChild(createNodeDOM(data, []));
}

function createNodeDOM(node, indentLines) {
  const isFolder = node.type === 'folder';
  const div = document.createElement('div');
  div.className = 't-node';
  
  const head = document.createElement('div');
  head.className = 't-head';
  
  // Header content logic (sama seperti sebelumnya)
  const arrowWrapper = document.createElement('span');
  if (isFolder) {
    arrowWrapper.innerHTML = ICONS.arrow;
    head.onclick = (e) => { if(!e.target.isContentEditable) div.classList.toggle('collapsed'); };
  } else {
    arrowWrapper.innerHTML = `<div class="t-arrow hidden"></div>`;
  }
  head.appendChild(arrowWrapper);

  const iconSpan = document.createElement('span');
  iconSpan.innerHTML = isFolder ? ICONS.folder : ICONS.file;
  if (!isFolder) {
    const ext = node.name.split('.').pop().toLowerCase();
    const map = {js:'c-js',ts:'c-ts',html:'c-html',css:'c-css',json:'c-json',md:'c-md',png:'c-img',jpg:'c-img',jpeg:'c-img'};
    iconSpan.firstElementChild.classList.add(map[ext] || 'c-def');
  }
  head.appendChild(iconSpan);

  const nameSpan = document.createElement('span');
  nameSpan.className = 't-name';
  nameSpan.textContent = node.name;
  head.appendChild(nameSpan);

  const metaSpan = document.createElement('span');
  metaSpan.className = 't-meta';
  metaSpan.textContent = isFolder ? `(${node.count})` : formatBytes(node.size);
  head.appendChild(metaSpan);

  const commentSpan = document.createElement('span');
  commentSpan.className = 't-comment';
  commentSpan.contentEditable = true;
  commentSpan.spellcheck = false;
  commentSpan.onclick = e => e.stopPropagation();
  head.appendChild(commentSpan);

  div.appendChild(head);

  if (isFolder) {
    const childrenContainer = document.createElement('div');
    childrenContainer.className = 't-children';
    Object.keys(node.children).forEach(key => {
      childrenContainer.appendChild(createNodeDOM(node.children[key], []));
    });
    div.appendChild(childrenContainer);
  }

  return div;
}

/* ================== EVENT LISTENERS (GLOBAL DROP) ================== */

// Attach Drag & Drop to BODY so you can drop anywhere to overwrite
['dragenter', 'dragover'].forEach(eventName => {
  document.body.addEventListener(eventName, e => {
    e.preventDefault();
    document.body.classList.add('drag-active');
  }, false);
});

['dragleave', 'drop'].forEach(eventName => {
  document.body.addEventListener(eventName, e => {
    e.preventDefault();
    // Only remove class if we are leaving the window or dropping
    if(eventName === 'drop' || (e.relatedTarget === null)) {
      document.body.classList.remove('drag-active');
    }
  }, false);
});

document.body.addEventListener('drop', e => {
  const dt = e.dataTransfer;
  if(dt && dt.files && dt.files.length) {
    processFiles(Array.from(dt.files));
  }
});

els.drop.onclick = () => els.pick.click();
els.pick.onchange = () => processFiles(Array.from(els.pick.files));

// Buttons
document.getElementById('btnCopy').onclick = () => {
  if(!fileStructure.name) return;
  const style = els.selStyle.value;
  const text = domToText(els.tree.firstElementChild, "", true, style);
  navigator.clipboard.writeText(text);
  showToast("Copied to clipboard!");
};

document.getElementById('btnJson').onclick = () => {
  if(!fileStructure.name) return;
  download(JSON.stringify(fileStructure, null, 2), "tree.json", "application/json");
};

document.getElementById('btnImg').onclick = () => {
  if(!fileStructure.name) return;
  showToast("Generating Image...");
  html2canvas(els.tree, { backgroundColor: "#1e293b", scale: 2 }).then(canvas => {
    const a = document.createElement('a');
    a.download = 'tree.png'; a.href = canvas.toDataURL(); a.click();
  });
};

/* ================== UTILS ================== */
function domToText(domNode, prefix, isLast, style) {
  if(!domNode) return "";
  const head = domNode.querySelector('.t-head');
  const name = head.querySelector('.t-name').textContent;
  const comment = head.querySelector('.t-comment').textContent;
  
  const CHARS = style === "unicode" 
    ? { branch: "├── ", last: "└── ", vert: "│   ", space: "    " }
    : { branch: "|-- ", last: "`-- ", vert: "|   ", space: "    " };

  let line = (prefix === "" && isLast === true) ? name : prefix + (isLast ? CHARS.last : CHARS.branch) + name;
  if(comment) line += "  # " + comment;
  line += "\n";

  const childrenContainer = domNode.querySelector('.t-children');
  if(childrenContainer && !domNode.classList.contains('collapsed')) {
    const children = Array.from(childrenContainer.children);
    children.forEach((child, i) => {
      const last = i === children.length - 1;
      const childPrefix = (prefix === "" && isLast === true) ? "" : prefix + (isLast ? CHARS.space : CHARS.vert);
      line += domToText(child, childPrefix, last, style);
    });
  }
  return line;
}

function formatBytes(bytes) {
  if(bytes === 0) return '';
  const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'], i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}
function download(c,n,t){ const b=new Blob([c],{type:t}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=n; a.click(); }
function showToast(msg) { document.getElementById('toastMsg').textContent=msg; els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'),2000); }
els.ignore.oninput = () => localStorage.setItem('pt_ignore', els.ignore.value);
els.ext.oninput = () => localStorage.setItem('pt_ext', els.ext.value);

</script>
</body>
</html>
